name: Deploy to Lolipop via WebDAV

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œ
  push:
    branches:
      - master # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§è‡ªå‹•å®Ÿè¡Œ

jobs:
  build-and-deploy:
    name: ãƒ“ãƒ«ãƒ‰ & WebDAVãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        env:
          BASE_PATH: /selflove
        run: npm run build

      - name: .htaccessãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
        run: |
          echo "ğŸ“„ .htaccessãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªä¸­..."
          if [ -f out/.htaccess ]; then
            echo "âœ… out/.htaccess ãŒå­˜åœ¨ã—ã¾ã™"
          else
            echo "âš ï¸ out/.htaccess ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€public/.htaccess ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™"
            cp public/.htaccess out/.htaccess
          fi
          cat out/.htaccess

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
        run: |
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰å®Œäº†ã€‚ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ï¼š"
          ls -la out/

      - name: å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        env:
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          echo "ğŸ§¹ å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."

          # index.htmlã‚’å‰Šé™¤
          curl -X DELETE \
            -k \
            --user "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "https://staba-mahounogakuen.webdav-lolipop.jp/selflove/index.html" 2>/dev/null || true

          # sitemap.xmlã‚’å‰Šé™¤
          curl -X DELETE \
            -k \
            --user "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "https://staba-mahounogakuen.webdav-lolipop.jp/selflove/sitemap.xml" 2>/dev/null || true

          # assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å†å¸°çš„ã«å‰Šé™¤ï¼ˆDepth: infinityãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãï¼‰
          curl -X DELETE \
            -k \
            -H "Depth: infinity" \
            --user "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "https://staba-mahounogakuen.webdav-lolipop.jp/selflove/assets/" 2>/dev/null || true

          # pdfãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚å‰Šé™¤
          curl -X DELETE \
            -k \
            -H "Depth: infinity" \
            --user "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "https://staba-mahounogakuen.webdav-lolipop.jp/selflove/pdf/" 2>/dev/null || true

          # audioãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚å‰Šé™¤
          curl -X DELETE \
            -k \
            -H "Depth: infinity" \
            --user "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "https://staba-mahounogakuen.webdav-lolipop.jp/selflove/audio/" 2>/dev/null || true

          echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
          echo "â³ å‰Šé™¤å‡¦ç†ã®å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          sleep 3

      - name: WebDAVã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        env:
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          echo "ğŸ“¤ WebDAVã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."

          cd out

          # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆ.htaccessã‚’é™¤å¤–ï¼‰
          find . -type f ! -name '.htaccess' | while read -r file; do
            # ./ ã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‘ã‚¹ã«ã™ã‚‹
            clean_path="${file#./}"

            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªéƒ¨åˆ†ã‚’å–å¾—
            dir_path=$(dirname "$clean_path")

            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒ . ã§ãªã„å ´åˆã¯ã€WebDAVã§ä½œæˆ
            if [ "$dir_path" != "." ]; then
              # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªéšå±¤ã‚’æ®µéšçš„ã«ä½œæˆ
              IFS='/' read -ra DIRS <<< "$dir_path"
              current_path=""
              for dir in "${DIRS[@]}"; do
                if [ -n "$current_path" ]; then
                  current_path="$current_path/$dir"
                else
                  current_path="$dir"
                fi

                curl -X MKCOL \
                  -k \
                  --user "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
                  "https://staba-mahounogakuen.webdav-lolipop.jp/selflove/$current_path" 2>/dev/null || true
              done
            fi

            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            echo "ğŸ“„ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: $clean_path"
            curl -T "$file" \
              -k \
              --user "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
              "https://staba-mahounogakuen.webdav-lolipop.jp/selflove/$clean_path"

            if [ $? -eq 0 ]; then
              echo "  âœ… æˆåŠŸ: $clean_path"
            else
              echo "  âŒ å¤±æ•—: $clean_path"
              exit 1
            fi
          done

          echo "âœ… ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†"

      - name: .htaccessã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        env:
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          echo "ğŸ“„ .htaccess ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."

          curl -T out/.htaccess \
            -k \
            --user "$WEBDAV_USERNAME:$WEBDAV_PASSWORD" \
            "https://staba-mahounogakuen.webdav-lolipop.jp/selflove/.htaccess"

          if [ $? -eq 0 ]; then
            echo "âœ… .htaccess ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†"
          else
            echo "âŒ .htaccess ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—"
            exit 1
          fi

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
        run: |
          echo "âœ… ãƒ­ãƒªãƒãƒƒãƒ—ã¸ã®WebDAVãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸŒ ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ: https://staba-mahounogakuen.webdav-lolipop.jp/selflove/"
