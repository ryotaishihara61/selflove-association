name: Deploy to Lolipop

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œ
  push:
    branches:
      - master # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§è‡ªå‹•å®Ÿè¡Œ

jobs:
  build-and-deploy:
    name: ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        run: npm run build

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
        run: |
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰å®Œäº†ã€‚ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ï¼š"
          ls -la out/

      - name: FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
        run: |
          cat > upload.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          # FTP_REMOTE_DIRãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          if [ -z "$FTP_REMOTE_DIR" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: FTP_REMOTE_DIR ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Secrets ã« FTP_REMOTE_DIR ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆä¾‹: public_html ã¾ãŸã¯ public_html/ ãªã©ï¼‰"
            exit 1
          fi

          # æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          REMOTE_DIR="${FTP_REMOTE_DIR%/}"

          echo "ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."
          echo "ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆ: $REMOTE_DIR/"

          cd out

          # FTPã‚³ãƒãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
          echo "ğŸ“ FTPã‚³ãƒãƒ³ãƒ‰ã‚’ç”Ÿæˆä¸­..."
          cat > /tmp/ftp_commands.txt << FTPEOF
          binary
          cd $REMOTE_DIR
          FTPEOF

          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          find . -type d -not -path '*/\.*' | while read dir; do
            if [ "$dir" != "." ]; then
              clean_dir="${dir#./}"
              echo "mkdir $clean_dir" >> /tmp/ftp_commands.txt
            fi
          done

          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          find . -type f -not -path '*/\.*' | while read file; do
            clean_file="${file#./}"
            echo "put $file $clean_file" >> /tmp/ftp_commands.txt
          done

          echo "bye" >> /tmp/ftp_commands.txt

          echo "ğŸ“¤ FTPã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œä¸­..."

          # FTPã§ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          ftp -n -v $FTP_SERVER <<ENDFTPCMD
          user $FTP_USERNAME $FTP_PASSWORD
          binary
          cd $REMOTE_DIR
          $(cat /tmp/ftp_commands.txt | grep -E '^(mkdir|put)' | while read cmd; do echo "$cmd"; done)
          bye
          ENDFTPCMD

          if [ $? -eq 0 ]; then
            echo "âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†"
          else
            echo "âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—"
            exit 1
          fi
          SCRIPT

          chmod +x upload.sh

      - name: ãƒ­ãƒªãƒãƒƒãƒ—ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: ./upload.sh

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
        run: echo "âœ… ãƒ­ãƒªãƒãƒƒãƒ—ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
