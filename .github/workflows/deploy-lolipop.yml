name: Deploy to Lolipop

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œ
  push:
    branches:
      - master # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§è‡ªå‹•å®Ÿè¡Œ

jobs:
  build-and-deploy:
    name: ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        run: npm run build

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
        run: |
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰å®Œäº†ã€‚ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ï¼š"
          ls -la out/

      - name: FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
        run: |
          cat > upload.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          echo "ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."

          # outãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          cd out
          find . -type f -not -path '*/\.*' | while read file; do
            # å…ˆé ­ã® ./ ã‚’å‰Šé™¤
            clean_file="${file#./}"

            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªéƒ¨åˆ†ã‚’å–å¾—
            dir=$(dirname "$clean_file")

            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            echo "Uploading: $clean_file"

            # curlã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            # ãƒ‡ãƒãƒƒã‚°: æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘verboseãƒ¢ãƒ¼ãƒ‰ã§è©³ç´°ã‚’è¡¨ç¤º
            if [ "$clean_file" == "index.html" ]; then
              echo "  [DEBUG] FTP URL: ftp://$FTP_SERVER/$clean_file"
              curl -u "$FTP_USERNAME:$FTP_PASSWORD" \
                --ftp-create-dirs \
                --ftp-pasv \
                --upload-file "$file" \
                "ftp://$FTP_SERVER/$clean_file" \
                --max-time 300 \
                --retry 3 \
                --retry-delay 5 \
                --verbose
            else
              curl -u "$FTP_USERNAME:$FTP_PASSWORD" \
                --ftp-create-dirs \
                --ftp-pasv \
                --upload-file "$file" \
                "ftp://$FTP_SERVER/$clean_file" \
                --max-time 300 \
                --retry 3 \
                --retry-delay 5 \
                --silent \
                --show-error
            fi

            if [ $? -eq 0 ]; then
              echo "  âœ“ Success"
            else
              echo "  âœ— Failed"
              exit 1
            fi
          done

          echo "âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†"
          SCRIPT

          chmod +x upload.sh

      - name: ãƒ­ãƒªãƒãƒƒãƒ—ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: ./upload.sh

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
        run: echo "âœ… ãƒ­ãƒªãƒãƒƒãƒ—ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
