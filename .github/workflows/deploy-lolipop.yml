name: Deploy to Lolipop

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œ
  push:
    branches:
      - master # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§è‡ªå‹•å®Ÿè¡Œ

jobs:
  build-and-deploy:
    name: ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        run: npm run build

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
        run: |
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰å®Œäº†ã€‚ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ï¼š"
          ls -la out/

      - name: FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
        run: |
          cat > upload.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          # FTP_REMOTE_DIRãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          if [ -z "$FTP_REMOTE_DIR" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: FTP_REMOTE_DIR ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Secrets ã« FTP_REMOTE_DIR ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆä¾‹: public_html ã¾ãŸã¯ public_html/ ãªã©ï¼‰"
            exit 1
          fi

          # æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          REMOTE_DIR="${FTP_REMOTE_DIR%/}"

          echo "ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."
          echo "ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆ: $REMOTE_DIR/"

          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åé›†
          cd out
          echo "ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆä¸­..."
          find . -type d -not -path '*/\.*' | while read dir; do
            if [ "$dir" != "." ]; then
              clean_dir="${dir#./}"
              remote_dir="$REMOTE_DIR/$clean_dir"
              echo "  Creating: $remote_dir"

              # FTPã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆï¼ˆQuoteä½¿ç”¨ï¼‰
              curl -u "$FTP_USERNAME:$FTP_PASSWORD" \
                --ftp-pasv \
                "ftp://$FTP_SERVER/" \
                -Q "MKD $remote_dir" \
                --silent \
                --show-error 2>/dev/null || true
            fi
          done

          echo "ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."

          # å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          find . -type f -not -path '*/\.*' | while read file; do
            # å…ˆé ­ã® ./ ã‚’å‰Šé™¤
            clean_file="${file#./}"

            # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆã®ãƒ•ãƒ«ãƒ‘ã‚¹
            remote_path="$REMOTE_DIR/$clean_file"

            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            echo "Uploading: $clean_file"

            # curlã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆãªã—ï¼‰
            curl -u "$FTP_USERNAME:$FTP_PASSWORD" \
              --ftp-pasv \
              --upload-file "$file" \
              "ftp://$FTP_SERVER/$remote_path" \
              --max-time 300 \
              --retry 3 \
              --retry-delay 5 \
              --silent \
              --show-error

            if [ $? -eq 0 ]; then
              echo "  âœ“ Success"
            else
              echo "  âœ— Failed: $clean_file"
              exit 1
            fi
          done

          echo "âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†"
          SCRIPT

          chmod +x upload.sh

      - name: ãƒ­ãƒªãƒãƒƒãƒ—ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: ./upload.sh

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
        run: echo "âœ… ãƒ­ãƒªãƒãƒƒãƒ—ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
